(window.webpackJsonp=window.webpackJsonp||[]).push([[4],{"1qWw":function(t,e,s){"use strict";var i=Math.floor;(function(t){s.d(e,"a",function(){return l});var a=s("W1QL"),o=(s.n(a),s("aBO9")),r=s("nUlG"),n=s("Q7Au"),d=s("f4w0"),h=s("Av7d");class l{constructor(t){this._ports=t,this._inputs=4,this._baseName="Get position",this._baseId="get-position",this._buttonId=`button-${this._baseId}`,this._modalId=`modal-${this._baseId}`,this._setupSvg(),this._setupListener()}_setupSvg(){this._gPosition=Object(r.select)("g.ports").append("g").classed("position",!0)}_navbarClick(t){Object(d.b)("Menu","Get position"),t.stopPropagation(),this._positionSelected()}_setupListener(){document.getElementById(`${this._buttonId}`).addEventListener("click",t=>this._navbarClick(t))}_injectModal(){Object(h.n)(this._modalId,this._baseName,"","Go");const t=Object(r.select)(`#${this._modalId} .modal-body`);t.append("div").classed("alert alert-primary",!0).attr("role","alert").text("Use in-game trader tool.");const e=t.append("form"),s=e.append("datalist").attr("id","defaultDistances");[5,10,15,20,30,50,100,200].forEach(t=>{s.append("option").attr("value",t)}),Array.from(Array(this._inputs).keys()).forEach(t=>{const s=`${this._baseId}-${t}-select`,i=`${this._baseId}-${t}-input`,a=e.append("div").classed("form-row",!0);a.append("div").classed("col-md-6",!0).append("label").append("select").attr("name",s).attr("id",s),a.append("div").classed("col-md-6",!0).append("input").attr("id",i).attr("name",i).attr("type","number").classed("form-control",!0).attr("placeholder","Distance in k").attr("step",1).attr("list","defaultDistances").attr("min",0).attr("max",1e3)})}_setupSelects(){const e=JSON.parse(JSON.stringify({noneSelectedText:"",dropupAuto:!1}));e.liveSearch=!0,e.liveSearchPlaceholder="Search ...",e.liveSearchNormalize=!0,e.noneSelectedText="Select port";const s=`${this._ports.portDataDefault.map(t=>({id:t.id,coord:[t.geometry.coordinates[0],t.geometry.coordinates[1]],name:t.properties.name,nation:this._ports.pbData.ports.filter(e=>e.id===t.id).map(t=>t.nation)})).sort((t,e)=>t.name<e.name?-1:t.name>e.name?1:0).map(t=>`<option data-subtext="${t.nation}" value="${t.coord}" data-id="${t.id}">${t.name}</option>`).join("")}`;Array.from(Array(this._inputs).keys()).forEach(i=>{const a=`${this._baseId}-${i}-select`,o=document.getElementById(a),r=t(`#${a}`);o.insertAdjacentHTML("beforeend",s),r.selectpicker(e).val("default").selectpicker("refresh")})}_initModal(){this._injectModal(),this._setupSelects()}_useUserInput(){const e=new Map;Array.from(Array(this._inputs).keys()).forEach(s=>{const i=`${this._baseId}-${s}-select`,a=t(`#${i}`),o=`${this._baseId}-${s}-input`,r=t(`#${o}`),n=a.find(":selected")[0]?a.find(":selected")[0].text:"",d=+r.val();d&&""!==n&&e.set(n,1.05*d*h.d)}),2<=e.size?(this._ports.showRadiusSetting="position",this._ports.portData=this._ports.portDataDefault.filter(t=>e.has(t.properties.name)).map(t=>(t.properties.distance=e.get(t.properties.name),t)),this._ports.update(),(()=>{const t=t=>{const e=[];return t.arcs.forEach(t=>{var s=Math.atan2;const a=t.p1,o=t.p2,r=t.circle,n=s(a.x-r.x,a.y-r.y),d=s(o.x-r.x,o.y-r.y);let h=d-n;0>h&&(h+=2*Math.PI);const l=h/32;Array.from(Array(32).keys()).forEach(t=>{const s=d-l*t,a={x:r.x+r.radius*Math.sin(s),y:r.y+r.radius*Math.cos(s)};e.push([i(a.x),i(a.y)])})}),e},e=e=>{const s=t(e),i=Object(o.e)().curve(o.c);this._gPosition.append("path").attr("d",i(s))},s=(()=>{const t=this._ports.portData.map(t=>({x:t.geometry.coordinates[0],y:t.geometry.coordinates[1],radius:t.properties.distance})),e={};return Object(n.a)(t,e),e})();if(s.innerPoints.length){e(s);const t=this._gPosition.select("path").node().getBBox(),i={x:t.x+t.width/2,y:t.y+t.height/2};this._ports._map._f11.printCoord(i.x,i.y),this._ports._map.zoomAndPan(i.x,i.y,1)}else console.error("Get position: no intersection found.")})()):console.error("Get position: not enough data.")}_positionSelected(){document.getElementById(this._modalId)||this._initModal(),t(`#${this._modalId}`).modal("show").on("hidden.bs.modal",()=>{this._useUserInput()})}clearMap(){this._gPosition.selectAll("*").remove()}}}).call(this,s("xeH2"))},"62GW":function(t,e,s){"use strict";var i=Math.max,a=Math.round,o=Math.PI;(function(t){s.d(e,"a",function(){return y});var r=s("MYxt"),n=(s.n(r),s("nUlG")),d=s("aBO9"),h=s("TiKg"),l=s.n(h),p=s("YmdP"),c=(s.n(p),s("W/Hz")),_=(s.n(c),s("8sDi")),u=(s.n(_),s("+NlM")),m=(s.n(u),s("kCRU")),g=(s.n(m),s("0lY5")),b=s("f4w0"),f=s("Av7d");class y{constructor(){this._height=300,this._width=300,this._windArrowWidth=4,this._baseName="Predict wind",this._baseId="predict-wind",this._buttonId=`button-${this._baseId}`,this._modalId=`modal-${this._baseId}`,this._formId=`form-${this._baseId}`,this._sliderId=`slider-${this._baseId}`,this._timeGroupId=`input-group-${this._baseId}`,this._timeInputId=`input-${this._baseId}`,this._setupSvg(),this._setupArrow(),this._setupListener()}_setupSvg(){this._svg=Object(n.select)("body").append("div").attr("id","wind").append("svg").style("position","absolute").classed("coord",!0)}_setupArrow(){const t=this._windArrowWidth,e=2*this._windArrowWidth;Object(n.select)("#na-svg defs").append("marker").attr("id","wind-arrow").attr("viewBox",`0 -${t} ${e} ${e}`).attr("refX",t).attr("refY",0).attr("markerWidth",t).attr("markerHeight",t).attr("orient","auto").append("path").attr("d",`M0,-${t}L${e},0L0,${t}`).classed("wind-head",!0)}_navbarClick(t){Object(b.b)("Menu","Predict wind"),t.stopPropagation(),this._windSelected()}_setupListener(){document.getElementById(`${this._buttonId}`).addEventListener("click",t=>this._navbarClick(t))}_setupWindInput(){const e=t.fn.roundSlider.prototype._getTooltipPos;t.fn.roundSlider.prototype._getTooltipPos=function(){this.tooltip.is(":visible")||t("body").append(this.tooltip);const s=e.call(this);return this.container.append(this.tooltip),s},window.tooltip=(t=>Object(g.g)(t.value)),t(`#${this._sliderId}`).roundSlider({sliderType:"default",handleSize:"+1",startAngle:90,width:20,radius:110,min:0,max:359,step:360/g.e.length,editableTooltip:!1,tooltipFormat:"tooltip",create(){this.control.css("display","block")},change(){this._currentWind=t(`#${this._sliderId}`).roundSlider("getValue")}})}_injectModal(){l.a.locale("en-gb"),Object(f.n)(this._modalId,this._baseName,"sm");const e=Object(n.select)(`#${this._modalId} .modal-body`).append("form").attr("id",this._formId),s=e.append("div").attr("class","form-group").append("div").classed("alert alert-primary",!0);s.append("label").attr("for",this._sliderId).text("Current in-game wind"),s.append("div").attr("id",this._sliderId).attr("class","rslider");const i=e.append("div").attr("class","form-group").append("div").classed("alert alert-primary",!0);i.append("label").attr("for",this._timeInputId).text("Predict time (server time)");const a=i.append("div").classed("input-group date",!0).attr("id",this._timeGroupId).attr("data-target-input","nearest");a.append("input").classed("form-control datetimepicker-input",!0).attr("type","text").attr("id",this._timeInputId).attr("data-target",`#${this._timeGroupId}`).attr("aria-label",this._timeGroupId).attr("required",""),a.append("div").classed("input-group-append",!0).attr("data-target",`#${this._timeGroupId}`).attr("data-toggle","datetimepicker").append("span").classed("input-group-text",!0).append("i").classed("far fa-clock",!0),t(`#${this._timeGroupId}`).datetimepicker({defaultDate:l.a.utc(),format:"LT"})}_initModal(){this._injectModal(),this._setupWindInput()}_windSelected(){document.getElementById(this._modalId)||this._initModal(),t(`#${this._modalId}`).modal("show").on("hidden.bs.modal",()=>{this._useUserInput()})}_useUserInput(){const e=t(`#${this._sliderId}`).roundSlider("getValue"),s=t(`#${this._timeInputId}`).val().trim();this._predictWind(e,s)}_predictWind(t,e){l.a.locale("en-gb");const s="H.mm";let i;const a=/(\d+)[\s:.](\d+)/.exec(e),o=parseInt(a[1],10),r=parseInt(a[2],10);i=Number.isNaN(+t)?Object(g.f)(t):+t;const n=l()().utc().seconds(0).milliseconds(0),d=l()(n).hour(o).minutes(r);d.isBefore(n)&&d.add(1,"day");const h=360+(i-.125*d.diff(n,"seconds"))%360;this._printPredictedWind(h,d.format(s),Object(g.g)(t),n.format(s))}_printCompass(t){const e=Object(d.e)(),s=this._width/2,i=this._height/3,r=o/180*(t-90),n=600/o*.6,h=n*Math.cos(r),l=n*Math.sin(r),p=[[a(s+h/2),a(i+l/2)],[a(s-h/2),a(i-l/2)]];this._svg.attr("height",this._height).attr("width",this._width);const c=this._svg.append("svg").attr("class","compass").classed("compass",!0).attr("x",s).attr("y",i);Object(g.u)({elem:c,compassSize:600}),this._svg.append("path").datum(p).attr("d",e).classed("wind",!0).attr("marker-end","url(#wind-arrow)")}_printText(t,e,s,a){const o=Object(g.g)(t),r=parseInt(window.getComputedStyle(document.getElementById("wind")).getPropertyValue("line-height"),10),n=this._svg.append("svg"),d=n.append("text").attr("x","50%").attr("y","33%").attr("class","wind-text").text(`From ${o} at ${e}`),h=n.append("text").attr("x","50%").attr("y","66%").attr("class","wind-text-current").text(`Currently at ${a} from ${s}`),l=d.node().getBoundingClientRect(),p=h.node().getBoundingClientRect(),c=2*i(l.height,p.height)+r,_=i(l.width,p.width)+r;n.attr("x",(this._width-_)/2).attr("y","66%").attr("height",c).attr("width",_)}_addBackground(){this._svg.insert("rect",":first-child").attr("x",0).attr("y",0).attr("height",this._height).attr("width",this._width)}_printPredictedWind(t,e,s,i){this.clearMap(),this._printCompass(t),this._printText(t,e,s,i),this._addBackground()}setPosition(t,e){this._svg.style("left",`${e}px`).style("top",`${t}px`)}clearMap(){this._svg.selectAll("*").remove()}}}).call(this,s("xeH2"))},"8gAj":function(t,e,s){"use strict";var i=Math.max,a=Math.round;(function(t){s.d(e,"a",function(){return C});var o=s("asZ9"),r=(s.n(o),s("W1QL")),n=(s.n(r),s("x8q/")),d=(s.n(n),s("/Cyf")),h=s("IVJf"),l=s("wbYc"),p=s("nUlG"),c=s("aBO9"),_=s("NRFW"),u=s("TiKg"),m=s.n(u),g=s("YmdP"),b=(s.n(g),s("W/Hz")),f=(s.n(b),s("8sDi")),y=(s.n(f),s("0lY5")),S=s("f4w0"),w=s("Av7d"),v=s("iSiJ"),x=s("pFgi");class C{constructor(t,e,s){this._shipData=t,this._woodData=e,this._fontSize=s,this._compassSize=600,this._courseArrowWidth=5,this._line=Object(c.e)().x(t=>t[0]).y(t=>t[1]),this._labelPadding=20,this._minutesForFullCircle=48,this._fullCircle=360,this._degreesPerMinute=this._fullCircle/this._minutesForFullCircle,this._degreesSegment=15,this._minOWSpeed=2,this._owSpeedFactor=2,this._speedScale=Object(l.scaleLinear)().domain(Object(d.e)(0,this._fullCircle,this._degreesSegment)),this._defaultShipName="None",this._defaultShipSpeed=19,this._defaultStartWindDegrees=0,this._baseName="Make journey",this._baseId="make-journey",this._buttonId=`button-${this._baseId}`,this._compassId=`compass-${this._baseId}`,this._deleteLastLegButtonId=`button-delete-leg-${this._baseId}`,this._modalId=`modal-${this._baseId}`,this._sliderId=`slider-${this._baseId}`,this._shipId="ship-journey",this._woodId="wood-journey",this._setupSummary(),this._setupDrag(),this._setupSvg(),this._initJourneyData(),this._setupListener()}_setupDrag(){this._drag=Object(h.a)().on("start",(t,e,s)=>{this._removeLabels(),Object(p.select)(s[e]).classed("drag-active",!0)}).on("drag",(t,e,s)=>{0===e&&this._compass.attr("x",t.position[0]+p.event.dx).attr("y",t.position[1]+p.event.dy),Object(p.select)(s[e]).attr("cx",p.event.x).attr("cy",p.event.y),t.position=[t.position[0]+p.event.dx,t.position[1]+p.event.dy],this._printLines()}).on("end",(t,e,s)=>{Object(p.select)(s[e]).classed("drag-active",!1),this._printJourney()})}_setupSvg(){const t=this._courseArrowWidth,e=2*this._courseArrowWidth;this._g=Object(p.select)("#na-svg").insert("g","g.pb").classed("coord",!0),Object(p.select)("#na-svg defs").append("marker").attr("id","course-arrow").attr("viewBox",`0 -${t} ${e} ${e}`).attr("refX",t).attr("refY",0).attr("markerWidth",t).attr("markerHeight",t).attr("orient","auto").append("path").attr("d",`M0,-${t}L${e},0L0,${t}`).classed("course-head",!0)}_initJourneyData(){this._journey={shipName:this._defaultShipName,woodNames:"",startWindDegrees:this._defaultStartWindDegrees,currentWindDegrees:this._defaultStartWindDegrees,totalDistance:0,totalMinutes:0,segment:[{position:[null,null],label:""}]}}_resetJourneyData(){this._journey.startWindDegrees=this._getStartWind(),this._journey.currentWindDegrees=this._journey.startWindDegrees,this._journey.totalDistance=0,this._journey.totalMinutes=0}_navbarClick(t){Object(S.b)("Menu","Journey"),t.stopPropagation(),this._journeySelected()}_setupListener(){document.getElementById(`${this._buttonId}`).addEventListener("mouseup",t=>this._navbarClick(t)),document.getElementById(this._deleteLastLegButtonId).addEventListener("mouseup",()=>this._deleteLastLeg())}_setupWindInput(){const e=t.fn.roundSlider.prototype._getTooltipPos;t.fn.roundSlider.prototype._getTooltipPos=function(){this.tooltip.is(":visible")||t("body").append(this.tooltip);const s=e.call(this);return this.container.append(this.tooltip),s},window.tooltip=(t=>Object(y.g)(t.value)),t(`#${this._sliderId}`).roundSlider({sliderType:"default",handleSize:"+1",startAngle:90,width:20,radius:110,min:0,max:359,step:360/y.e.length,editableTooltip:!1,tooltipFormat:"tooltip",create(){this.control.css("display","block")},change(){this._currentWind=t(`#${this._sliderId}`).roundSlider("getValue")}})}_injectModal(){Object(w.n)(this._modalId,this._baseName,"sm");const t=Object(p.select)(`#${this._modalId} .modal-body`).append("form").append("div").attr("class","form-group"),e=t.append("div").classed("alert alert-primary",!0).attr("role","alert");e.append("label").attr("for",this._sliderId).text("Current in-game wind"),e.append("div").attr("id",this._sliderId).attr("class","rslider");const s=`${this._shipId}-Base-select`,i=t.append("div").classed("alert alert-primary",!0).attr("role","alert").append("div").attr("class","d-flex flex-column");i.append("label").attr("for",s).text("Ship and woods (optional)"),i.append("select").attr("name",s).attr("id",s),["frame","trim"].forEach(t=>{const e=`${this._woodId}-${t}-Base-select`;i.append("label").attr("for",e),i.append("select").attr("name",e).attr("id",e)})}_initModal(){this._injectModal(),this._setupWindInput(),this._shipCompare=new v.a(this._shipData,this._woodData,this._shipId),this._woodCompare=new x.a(this._woodData,this._woodId)}_useUserInput(){this._resetJourneyData(),this._journey.startWindDegrees=this._getStartWind(),this._setShipName(),this._printSummary(),this._printJourney()}_journeySelected(){document.getElementById(this._modalId)||this._initModal(),t(`#${this._modalId}`).modal("show").on("hidden.bs.modal",()=>{this._useUserInput()})}_printCompass(){const t=this._journey.segment[0].position[0],e=this._journey.segment[0].position[1];this._compass=this._g.append("svg").attr("id",this._compassId).attr("class","compass").attr("x",t).attr("y",e).call(this._drag),this._compassG=this._compass.append("g"),Object(y.u)({elem:this._compassG,compassSize:this._compassSize})}_removeCompass(){this._compass.remove()}_getSpeedAtDegrees(t){return i(this._speedScale(t),this._minOWSpeed)}_calculateDistanceForSection(t,e){const s=(this._fullCircle-t+e)%this._fullCircle;return this._getSpeedAtDegrees(s)*this._owSpeedFactor*w.p}_getStartWind(){const e=t(`#${this._sliderId}`).roundSlider("getValue");let s;return s=t(`#${this._sliderId}`).length?+e:0}_setShipSpeed(){let t=[];t=this._journey.shipName===this._defaultShipName?Array.from(Array(24).fill(this._defaultShipSpeed/2)):this._shipCompare._singleShipData.speedDegrees,this._speedScale.range(t)}_calculateMinutesForSegment(t,e,s){let i=s,a=e,o=0;for(this._setShipSpeed();0<i;){const e=this._calculateDistanceForSection(t,a);i>e?(i-=e,o+=1):(o+=i/e,i=0),a=(this._fullCircle+a-this._degreesPerMinute)%this._fullCircle}return this._journey.currentWindDegrees=a,o}_setShipName(){void 0!==this._shipCompare&&void 0!==this._shipCompare._singleShipData&&void 0!==this._shipCompare._singleShipData.name?(this._journey.shipName=`${this._shipCompare._singleShipData.name}`,this._journey.woodNames=`${this._shipCompare._woodCompare._woodsSelected.Base.frame}/${this._shipCompare._woodCompare._woodsSelected.Base.trim}`):(this._journey.shipName=this._defaultShipName,this._journey.woodNames="")}_removeLabels(){const t=this._g.selectAll("g.coord g.label");t.select("text").remove(),t.select("rect").remove()}_correctJourney(){const t=Object(_.c)(Object(p.select)("#na-svg").node()),e=i(1,t.k),s=this._fontSize/e,a=_.b.translate(20/e,20/e),o=this._labelPadding/e,r=10/e;this._g.selectAll("g.coord g.label").each((t,e,i)=>{const n=Object(p.select)(i[e]),d=n.select("text"),h=t.label.split("|");d.text("").attr("dy",0).attr("transform",a).style("font-size",`${s}px`),h.forEach((t,e)=>{const i=d.append("tspan").text(t);0<e&&i.attr("x",0).attr("dy",1.3*s)});const l=d.node().getBBox(),c=t.label?l.width+2*o:0,_=t.label?l.height+o:0;n.select("rect").attr("width",c).attr("height",_);const u=n.select("circle").attr("r",r).attr("class","");n.append(()=>u.remove().node()),0===e&&u.attr("r",4*r).attr("class","drag-hidden"),e===i.length-1&&u.attr("r",r).attr("class","drag-hidden")}),this._gJourneyPath&&this._gJourneyPath.style("stroke-width",`${5/e}px`),this._compassG&&this._compassG.attr("transform",`scale(${1/e})`)}_printLabels(){const t=Object(n.layoutTextLabel)().padding(this._labelPadding).value(t=>{const e=t.label.split("|"),s=e.reduce((t,e,s,i)=>i[t].length>e.length?t:s,0);return e[s]}),e=Object(n.layoutAnnealing)(),s=Object(n.layoutLabel)(e).size((t,e,s)=>{const i=t.label.split("|").length,a=s[e].getElementsByTagName("text")[0].getBBox();return[a.width+2*this._labelPadding,a.height*i+2*this._labelPadding]}).position(t=>t.position).component(t);this._g.datum(this._journey.segment.map(t=>t)).call(s)}_setupSummary(){this._divJourneySummary=Object(p.select)("main").append("div").attr("id","journey-summary").classed("journey-summary overlay d-none",!0);const t=this._divJourneySummary.append("div").classed("d-flex justify-content-around align-items-end",!0);this._journeySummaryShip=t.append("div").classed("block",!0),this._journeySummaryTextWoods=this._journeySummaryShip.append("div"),this._journeySummaryTextShip=this._journeySummaryShip.append("div"),this._journeySummaryShip.append("div").classed("des",!0).text("selected ship"),this._journeySummaryWind=t.append("div").classed("block",!0),this._journeySummaryTextWind=this._journeySummaryWind.append("div"),this._journeySummaryWind.append("div").classed("des",!0).text("wind direction"),t.append("button").attr("id",this._deleteLastLegButtonId).classed("btn btn-primary btn-sm",!0).attr("role","button").text("Delete last leg")}_displaySummary(t){this._divJourneySummary.classed("d-none",!t),Object(p.select)("#port-summary").classed("d-none",t)}_showSummary(){this._displaySummary(!0)}_hideSummary(){this._displaySummary(!1)}_printSummaryShip(){this._journeySummaryTextWoods.text(this._journey.woodNames),this._journeySummaryTextShip.text(this._journey.shipName)}_printSummaryWind(){this._journeySummaryTextWind.text(`From ${Object(y.g)(this._journey.startWindDegrees)}`)}_printSummary(){this._printSummaryWind(),this._printSummaryShip()}_printLines(){this._gJourneyPath&&this._gJourneyPath.datum(1<this._journey.segment.length?this._journey.segment.map(t=>t.position):[[null,null]]).attr("marker-end","url(#course-arrow)").attr("d",this._line)}_getTextDirection(t,e,s){return`${t} (${a(e)}°) ☆ F11: ${Object(y.j)(Object(w.g)(s.x,s.y))} / ${Object(y.j)(Object(w.h)(s.x,s.y))}`}_getTextDistance(t,e,s){function i(t){function e(t,e){return`${t} ${e+(1===t?"":"s")}`}m.a.locale("en-gb");const s=Math.floor(t/60),i=a(t%60);let o="in ";if(1>t)o+="less than a minute";else{const t=0===s?"":e(s,"hour");o+=t+(""===t?"":" ")+(0===i?"":e(i,"minute"))}return o}let o=`${a(t)}k ${i(e)}`;return s&&(o+=` ☆ total ${a(this._journey.totalDistance)}k ${i(this._journey.totalMinutes)}`),o}_setSegmentLabel(t){void 0===t&&(t=this._journey.segment.length-1);const e={x:this._journey.segment[t].position[0],y:this._journey.segment[t].position[1]},s={x:this._journey.segment[t-1].position[0],y:this._journey.segment[t-1].position[1]},i=Object(y.w)(e,s),a=Object(w.l)(e,s),o=Object(y.g)(i),r=this._calculateMinutesForSegment(i,this._journey.currentWindDegrees,1e3*a);this._journey.totalDistance+=a,this._journey.totalMinutes+=r;const n=this._getTextDirection(o,i,e),d=this._getTextDistance(a,r,1<t);this._journey.segment[t].label=`${n}|${d}`}_printSegment(){this._printLines(),this._setSegmentLabel(),this._printLabels(),this._correctJourney(),this._g.selectAll("g.coord g.label circle").call(this._drag)}_printJourney(){this._printLines(),this._resetJourneyData(),this._journey.segment.forEach((t,e)=>{e<this._journey.segment.length-1&&this._setSegmentLabel(e+1)}),this._printLabels(),this._correctJourney(),this._g.selectAll("g.coord g.label circle").call(this._drag)}_deleteLastLeg(){this._journey.segment.pop(),this._journey.segment.length?this._printJourney():(this._removeCompass(),this._initJourneyData())}_initJourney(){this._showSummary(),this._printSummary(),this._printCompass(),this._gJourneyPath=this._g.append("path")}setSummaryPosition(t,e){this._divJourneySummary.style("top",`${t}px`).style("right",`${e}px`)}plotCourse(t,e){this._journey.segment[0].position[0]?(this._journey.segment.push({position:[t,e],label:""}),this._printSegment()):(this._journey.segment[0]={position:[t,e],label:""},this._initJourney())}transform(t){this._g.attr("transform",t),this._correctJourney()}}}).call(this,s("xeH2"))},FmV8:function(t,e,s){"use strict";var i=Math.log2,a=Math.round;(function(t){var o=Math.abs;s.d(e,"a",function(){return f});var r=s("W1QL"),n=(s.n(r),s("/Cyf")),d=s("wbYc"),h=s("nUlG"),l=s("2W1i"),p=s.n(l),c=s("TiKg"),_=s.n(c),u=s("YmdP"),m=(s.n(u),s("Av7d")),g=s("0lY5"),b=s("1qWw");class f{constructor(t,e,s){this._portDataDefault=t,this._portData=t,this._pbData=e,this._map=s,this._serverName=this._map._serverName,this._minScale=this._map._minScale,this._scale=this._minScale,this.f11=this._map._f11,this.showCurrentGood=!1,this.showTradePortPartners=!1,this._currentPort={id:"366",coord:{x:4396,y:2494}},this._zoomLevel="initial",this._showPBZones="all",this._tooltipDuration=200,this._iconSize=48,this._fontSize=m.j,this._circleSize=m.i,this._showRadius="attack",this._taxIncomeRadius=Object(d.scaleLinear)(),this._netIncomeRadius=Object(d.scaleLinear)(),this._attackRadius=Object(d.scaleLinear)().domain([0,1]),this._colourScale=Object(d.scaleLinear)().domain([0,.1,.5,1]).range(["#eaeded","#8b989c","#6b7478","#a62e39"]),this._minRadiusFactor=1,this._maxRadiusFactor=6,this._showRadiusCookieName="na-map--show-radius",this._showRadiusDefault="attack",this._showRadius=this._getShowRadiusSetting(),this._setupListener(),this._setupSvg(),this._setupCounties(),this._setupRegions(),this._setupSummary(),this._setupFlags(),this._trilateratePosition=new b.a(this)}_setupListener(){t("#show-radius").change(()=>this._showRadiusSelected())}_getShowRadiusSetting(){let e=p.a.get(this._showRadiusCookieName);return e=void 0===e?this._showRadiusDefault:e,t(`#show-radius-${e}`).prop("checked",!0),e}_storeShowRadiusSetting(){this._showRadius===this._showRadiusDefault?p.a.remove(this._showRadiusCookieName):p.a.set(this._showRadiusCookieName,this._showRadius)}_showRadiusSelected(){this._showRadius=t("input[name='showRadius']:checked").val(),this._storeShowRadiusSetting(),this.update()}_setupSvg(){this._gPort=Object(h.select)("#na-svg").insert("g","g.f11").classed("ports",!0),this._gRegion=this._gPort.append("g").classed("region",!0),this._gCounty=this._gPort.append("g").classed("county",!0),this._gPortCircle=this._gPort.append("g").classed("port-circles",!0),this._gIcon=this._gPort.append("g").classed("port",!0),this._gText=this._gPort.append("g").classed("port-names",!0)}_setupCounties(){this._countyPolygon=[{name:"Abaco",centroid:[4500,1953],angle:0},{name:"Andros",centroid:[3870,2350],angle:0},{name:"Apalache",centroid:[2800,1330],angle:0},{name:"Bacalar",centroid:[2050,3646],angle:0},{name:"Baracoa",centroid:[4750,3320],angle:25},{name:"Basse-Terre",centroid:[7540,4450],angle:0},{name:"Belize",centroid:[1900,4300],angle:0},{name:"Benedenwinds",centroid:[6187,5340],angle:0},{name:"Bermuda",centroid:[7550,210],angle:0},{name:"Bovenwinds",centroid:[7280,4180],angle:350},{name:"Campeche",centroid:[980,3791],angle:0},{name:"Cap-Français",centroid:[5270,3480],angle:0},{name:"Caracas",centroid:[6430,5750],angle:0},{name:"Cartagena",centroid:[4450,6024],angle:0},{name:"Caymans",centroid:[3116,3811],angle:0},{name:"Cayos del Golfo",centroid:[1240,3120],angle:0},{name:"Comayaqua",centroid:[1920,4500],angle:0},{name:"Cornwall",centroid:[4100,3845],angle:0},{name:"Costa de los Calos",centroid:[2850,1928],angle:0},{name:"Costa del Fuego",centroid:[3700,1670],angle:70},{name:"Costa Rica",centroid:[3140,5920],angle:0},{name:"Crooked",centroid:[4925,2950],angle:0},{name:"Cuidad de Cuba",centroid:[4500,3495],angle:0},{name:"Cumaná",centroid:[7280,5770],angle:0},{name:"Dominica",centroid:[7640,4602],angle:0},{name:"Exuma",centroid:[4700,2560],angle:0},{name:"Filipina",centroid:[2850,3100],angle:340},{name:"Florida Occidental",centroid:[2172,1200],angle:0},{name:"Georgia",centroid:[3670,747],angle:0},{name:"Golfo de Maracaibo",centroid:[5635,5601],angle:0},{name:"Grand Bahama",centroid:[3950,1850],angle:320},{name:"Grande-Terre",centroid:[8e3,4400],angle:35},{name:"Gustavia",centroid:[7720,3990],angle:0},{name:"Inagua",centroid:[4970,3220],angle:0},{name:"Isla de Pinos",centroid:[3150,3300],angle:0},{name:"Kidd’s Island",centroid:[5950,1120],angle:0},{name:"La Habana",centroid:[2850,2800],angle:340},{name:"La Vega",centroid:[5830,3530],angle:20},{name:"Lago de Maracaibo",centroid:[5550,6040],angle:0},{name:"Leeward Islands",centroid:[7850,4150],angle:0},{name:"Les Cayes",centroid:[5145,4050],angle:0},{name:"Los Llanos",centroid:[3640,2770],angle:30},{name:"Los Martires",centroid:[3300,2360],angle:0},{name:"Louisiane",centroid:[1420,1480],angle:0},{name:"Margarita",centroid:[7150,5584],angle:0},{name:"Martinique",centroid:[7700,4783],angle:0},{name:"Mérida",centroid:[1858,3140],angle:0},{name:"New Providence",centroid:[4500,2330],angle:0},{name:"North Carolina",centroid:[4580,150],angle:0},{name:"North Mosquito",centroid:[2420,4480],angle:0},{name:"Nuevitas del Principe",centroid:[4350,3050],angle:35},{name:"Nuevo Santander",centroid:[450,2594],angle:0},{name:"Orinoco",centroid:[7620,6e3],angle:0},{name:"Ponce",centroid:[6720,4040],angle:0},{name:"Port-au-Prince",centroid:[5e3,3800],angle:0},{name:"Portobelo",centroid:[3825,5990],angle:0},{name:"Providencia",centroid:[3436,5033],angle:0},{name:"Quatro Villas",centroid:[3780,3100],angle:35},{name:"Royal Mosquito",centroid:[3130,4840],angle:0},{name:"Sainte-Lucie",centroid:[7720,4959],angle:0},{name:"San Juan",centroid:[6760,3800],angle:0},{name:"Santa Marta",centroid:[5150,5500],angle:340},{name:"Santo Domingo",centroid:[5880,4e3],angle:350},{name:"South Carolina",centroid:[4200,416],angle:0},{name:"South Cays",centroid:[4170,4361],angle:0},{name:"South Mosquito",centroid:[3080,5540],angle:0},{name:"Surrey",centroid:[4350,4100],angle:0},{name:"Texas",centroid:[750,1454],angle:0},{name:"Timucua",centroid:[3620,1220],angle:0},{name:"Trinidad",centroid:[7880,5660],angle:350},{name:"Turks and Caicos",centroid:[5515,3145],angle:0},{name:"Vera Cruz",centroid:[520,3779],angle:0},{name:"Vestindiske Øer",centroid:[7090,4030],angle:350},{name:"Virgin Islands",centroid:[7220,3840],angle:350},{name:"Windward Isles",centroid:[7800,5244],angle:0}]}_setupRegions(){this._regionPolygon=[{name:"Atlantic Coast",centroid:[4200,970],angle:0},{name:"Atlantic",centroid:[6401,684],angle:0},{name:"Bahamas",centroid:[5100,2400],angle:0},{name:"Central America",centroid:[3e3,5100],angle:0},{name:"Central Antilles",centroid:[6900,4500],angle:0},{name:"East Cuba",centroid:[4454,3400],angle:20},{name:"Gulf",centroid:[1602,2328],angle:0},{name:"Hispaniola",centroid:[5477,4200],angle:0},{name:"Jamaica",centroid:[3500,3985],angle:0},{name:"Lower Antilles",centroid:[7100,5173],angle:0},{name:"Puerto Rico",centroid:[6900,3750],angle:0},{name:"South America",centroid:[6400,6100],angle:0},{name:"Upper Antilles",centroid:[6850,4250],angle:0},{name:"West Cuba",centroid:[3300,3100],angle:20},{name:"Yucatan",centroid:[1462,3550],angle:0}]}_setupSummary(){this._divPortSummary=Object(h.select)("main").append("div").attr("id","port-summary").attr("class","port-summary overlay");const t=this._divPortSummary.append("div").attr("class","d-flex justify-content-around align-items-end");this._portSummaryNumPorts=t.append("div").classed("block",!0),this._portSummaryTextNumPorts=this._portSummaryNumPorts.append("div"),this._portSummaryNumPorts.append("div").classed("des",!0).text("selected ports"),this._portSummaryTaxIncome=t.append("div").classed("block",!0),this._portSummaryTextTaxIncome=this._portSummaryTaxIncome.append("div"),this._portSummaryTaxIncome.append("div").classed("des",!0).text("tax income"),this._portSummaryNetIncome=t.append("div").classed("block",!0),this._portSummaryTextNetIncome=this._portSummaryNetIncome.append("div"),this._portSummaryNetIncome.append("div").classed("des",!0).text("net income")}_setupFlags(){const t=Object(h.select)("#na-svg defs");m.o.map(t=>t.short).forEach(e=>{const s=t.append("pattern").attr("id",e).attr("width","133%").attr("height","100%").attr("viewBox",`6 6 ${this._iconSize} ${.75*this._iconSize}`);s.append("image").attr("height",this._iconSize).attr("width",this._iconSize).attr("href",`icons/${e}.svg`),s.append("rect").attr("height",this._iconSize).attr("width",this._iconSize).attr("class","nation");const i=t.append("pattern").attr("id",`${e}a`).attr("width","133%").attr("height","100%").attr("viewBox",`6 6 ${this._iconSize} ${.75*this._iconSize}`);i.append("image").attr("height",this._iconSize).attr("width",this._iconSize).attr("href",`icons/${e}.svg`),i.append("rect").attr("height",this._iconSize).attr("width",this._iconSize).attr("class","all")});const e=t.append("filter").attr("id","drop-shadow").attr("width","200%").attr("height","200%");e.append("feGaussianBlur").attr("in","SourceAlpha").attr("stdDeviation",5).attr("result","blur"),e.append("feOffset").attr("dx",2).attr("dy",4).attr("result","offsetblur1"),e.append("feOffset").attr("dx",3).attr("dy",6).attr("result","offsetblur2").attr("in","blur"),e.append("feComponentTransfer").attr("result","shadow1").attr("in","offsetblur1").append("feFuncA").attr("type","linear").attr("slope","0.1"),e.append("feComponentTransfer").attr("result","shadow2").attr("in","offsetblur2").append("feFuncA").attr("type","linear").attr("slope","0.1"),e.append("feComposite").attr("in2","offsetblur1").attr("operator","in");const s=e.append("feMerge");s.append("feMergeNode").attr("in","shadow1"),s.append("feMergeNode").attr("in","shadow2"),s.append("feMergeNode").attr("in","SourceGraphic")}_getPortName(t){return t?this._portDataDefault.find(e=>e.id===t).properties.name:""}_getText(t,e){_.a.locale("en-gb");const s=this._pbData.ports.find(e=>e.id===t),i=_.a.utc(s.portBattle).local(),a=_.a.utc(s.portBattle),o={name:e.name,icon:s.nation,availableForAll:e.availableForAll?"(accessible to all nations)":"",depth:e.shallow?"Shallow":"Deep",county:(""===e.county?"":`${e.county} / `)+e.region,countyCapital:e.countyCapital?" (county capital)":"",nonCapturable:e.nonCapturable,captured:s.capturer?` captured by ${s.capturer} ${_.a.utc(s.lastPortBattle).fromNow()}`:"",lastPortBattle:s.lastPortBattle,attack:s.attackHostility?`${s.attackerClan} (${s.attackerNation}) attack${s.portBattle.length?`${a.isAfter(_.a.utc())?"s":"ed"} ${a.fromNow()} at ${a.format("H.mm")}${a===i?"":` (${i.format("H.mm")} local)`}`:`s: ${Object(g.n)(s.attackHostility)} hostility`}`:"",pbTimeRange:e.nonCapturable?"":e.portBattleStartTime?`${(e.portBattleStartTime+10)%24}.00 – ${(e.portBattleStartTime+13)%24}.00`:"11.00 – 8.00",brLimit:Object(g.m)(e.brLimit),conquestMarksPension:e.conquestMarksPension,taxIncome:Object(g.o)(e.taxIncome),portTax:Object(g.n)(e.portTax),netIncome:Object(g.o)(e.netIncome),tradingCompany:e.tradingCompany?`, trading company level ${e.tradingCompany}`:"",laborHoursDiscount:e.laborHoursDiscount?`, labor hours discount level ${e.laborHoursDiscount}`:"",dropsTrading:e.dropsTrading?e.dropsTrading.map(t=>t.name).sort().join(", "):"",consumesTrading:e.consumesTrading?e.consumesTrading.map(t=>t.name).sort().join(", "):"",producesNonTrading:e.producesNonTrading?e.producesNonTrading.map(t=>t.name).sort().join(", "):"",dropsNonTrading:e.dropsNonTrading?e.dropsNonTrading.map(t=>t.name).sort().join(", "):"",tradePort:this._getPortName(this.tradePortId),goodsToSellInTradePort:e.goodsToSellInTradePort?e.goodsToSellInTradePort.join(", "):"",goodsToBuyInTradePort:e.goodsToBuyInTradePort?e.goodsToBuyInTradePort.join(", "):""};switch(e.portBattleType){case"Large":o.pbType="1<sup>st</sup>";break;case"Medium":o.pbType="4<sup>th</sup>";break;default:o.pbType="6<sup>th</sup>"}return o}_showDetails(e,s,i){const a=Object(h.select)(i[s]),o=(t=>{let e=`<table><tbody><tr><td><i class="flag-icon ${t.icon}"></i></td>`;return e+=`<td><span class="port-name">${t.name}</span>`,e+=` ${t.county} ${t.availableForAll}`,e+="</td></tr></tbody></table>",t.attack.length&&(e+=`<div class="alert alert-danger mt-2" role="alert">${t.attack}</div>`),e+=`<p>${t.depth} water port ${t.countyCapital}${t.captured}<br>`,t.nonCapturable?(e+="Not capturable",e+=`<br>${t.portTax} tax`):(e+=`Port battle ${t.pbTimeRange}, ${t.brLimit} BR, `,e+=`${t.pbType} rate AI, `,e+=`${t.conquestMarksPension} conquest point`,e+=1<t.conquestMarksPension?"s":"",e+=`<br>Tax income ${t.taxIncome} (${t.portTax}), net income ${t.netIncome}`,e+=t.tradingCompany,e+=t.laborHoursDiscount),e+="</p>",e+="<table class='table table-sm'>",t.producesNonTrading.length&&(e+="<tr><td>Produces </td><td>",e+=`<span class="non-trading">${t.producesNonTrading}</span>`,e+="</td></tr>"),(t.dropsTrading.length||t.dropsNonTrading.length)&&(e+=`<tr><td>Drops ${t.dropsNonTrading.length?" ":""}</td><td>`,t.dropsNonTrading.length&&(e+=`<span class="non-trading">${t.dropsNonTrading}</span>`,t.dropsTrading.length&&(e+="<br>")),t.dropsTrading.length&&(e+=`${t.dropsTrading}`),e+="</td></tr>"),t.consumesTrading.length&&(e+="<tr><td>Consumes </td><td>",e+=t.consumesTrading,e+="</td></tr>"),this.showTradePortPartners&&(t.goodsToSellInTradePort.length&&(e+=`<tr><td>Sell in ${t.tradePort}</td><td>${t.goodsToSellInTradePort}</td></tr>`),t.goodsToBuyInTradePort.length&&(e+=`<tr><td>Buy in ${t.tradePort}</td><td>${t.goodsToBuyInTradePort}</td></tr>`)),e+="</table>"})(this._getText(e.id,e.properties));t(a.node()).tooltip({delay:{show:this._tooltipDuration,hide:this._tooltipDuration},html:!0,placement:"auto",title:o,trigger:"manual"}).tooltip("show")}_updateIcons(){const e=2**i(o(this._minScale)+this._scale),s=Object(g.x)(this._circleSize/e),a=this._portData.filter(t=>this._pbData.ports.some(e=>t.id===e.id)).map(t=>(t.properties.nation=this._pbData.ports.find(e=>t.id===e.id).nation,t)),r=this._gIcon.selectAll("circle").data(a,t=>t.id);r.exit().remove();const n=r.enter().append("circle").attr("fill",t=>`url(#${t.properties.availableForAll?`${t.properties.nation}a`:t.properties.nation})`).attr("cx",t=>t.geometry.coordinates[0]).attr("cy",t=>t.geometry.coordinates[1]).on("click",(t,e,s)=>this._showDetails(t,e,s)).on("mouseout",function(e,s,i){t(Object(h.select)(i[s]).node()).tooltip("dispose")});r.merge(n).attr("r",()=>s)}_updatePortCircles(){const t=t=>{let e="";return t.id===this.tradePortId?e="here":t.properties.sellInTradePort&&t.properties.buyInTradePort?e="both":t.properties.sellInTradePort?e="pos":t.properties.buyInTradePort&&(e="neg"),e},e=2**i(o(this._minScale)+this._scale),s=Object(g.x)(this._circleSize/e*this._minRadiusFactor);let a=Object(g.x)(this._circleSize/e*this._maxRadiusFactor),r={},d=0;if("tax"===this._showRadius||"net"===this._showRadius)r=this._portData.filter(t=>!t.properties.nonCapturable);else if(this.showTradePortPartners)r=this._portData;else if("position"===this._showRadius)r=this._portData;else if("attack"===this._showRadius){const t=this._pbData.ports.filter(t=>t.attackHostility).map(t=>({id:t.id,attackHostility:t.attackHostility}));r=this._portData.filter(e=>t.some(t=>e.id===t.id)).map(e=>(e.properties.attackHostility=t.find(t=>e.id===t.id).attackHostility,e))}else if("green"===this._showRadius){d=Object(g.x)(Object(m.l)({x:Object(m.e)(-63400,18800),y:Object(m.f)(-63400,18800)},{x:Object(m.e)(-79696,10642),y:Object(m.f)(-79696,10642)}))*m.d;const t=this._pbData.ports.filter(t=>"FT"!==t.nation).map(t=>t.id);r=this._portData.filter(e=>t.some(t=>e.id===t)&&e.properties.nonCapturable)}else this.showCurrentGood&&(r=this._portData,a/=2);const h=this._gPortCircle.selectAll("circle").data(r,t=>t.id);h.exit().remove();const l=h.enter().append("circle").attr("cx",t=>t.geometry.coordinates[0]).attr("cy",t=>t.geometry.coordinates[1]),p=h.merge(l);if("tax"===this._showRadius){const t=Object(n.d)(r,t=>t.properties.taxIncome),e=Object(n.c)(r,t=>t.properties.taxIncome);this._taxIncomeRadius.domain([t,e]),this._taxIncomeRadius.range([s,a]),p.attr("class","bubble pos").attr("r",t=>this._taxIncomeRadius(o(t.properties.taxIncome)))}else if("net"===this._showRadius){const t=Object(n.d)(r,t=>t.properties.netIncome),e=Object(n.c)(r,t=>t.properties.netIncome);this._netIncomeRadius.domain([t,e]).range([s,a]),p.attr("class",t=>`bubble ${0>t.properties.netIncome?"neg":"pos"}`).attr("r",t=>this._netIncomeRadius(o(t.properties.netIncome)))}else this.showTradePortPartners?p.attr("class",e=>`bubble ${t(e)}`).attr("r",t=>t.id===this.tradePortId?a:a/2):"attack"===this._showRadius?(this._attackRadius.range([s,a]),p.attr("class","bubble").attr("fill",t=>this._colourScale(t.properties.attackHostility)).attr("r",t=>this._attackRadius(t.properties.attackHostility))):"position"===this._showRadius?p.attr("class","position").attr("r",t=>t.properties.distance):"green"===this._showRadius?p.attr("class","bubble pos").attr("r",d):this.showCurrentGood&&p.attr("class",t=>`bubble ${t.properties.isSource?"pos":"neg"}`).attr("r",a)}_updateTextsX(t,e){return"pbZone"===this._zoomLevel&&("all"===this._showPBZones||"single"===this._showPBZones&&t.id===this.currentPort.id)?t.geometry.coordinates[0]+a(1.2*e*Math.cos(Object(g.h)(t.properties.angle))):t.geometry.coordinates[0]}_updateTextsY(t,e,s){const i=e+1.2*s;if("pbZone"!==this._zoomLevel)return t.geometry.coordinates[1]+i;const o=90<t.properties.angle&&270>t.properties.angle?s:0;return"all"===this._showPBZones||"single"===this._showPBZones&&t.id===this.currentPort.id?t.geometry.coordinates[1]+a(1.2*e*Math.sin(Object(g.h)(t.properties.angle)))+o:t.geometry.coordinates[1]+i}_updateTextsAnchor(t){return"pbZone"===this._zoomLevel&&("all"===this._showPBZones||"single"===this._showPBZones&&t.id===this.currentPort.id)?t.properties.textAnchor:"middle"}updateTexts(){if("initial"===this._zoomLevel)this._gText.classed("d-none",!0);else{const t=2**i(o(this._minScale)+this._scale),e=Object(g.x)(this._circleSize/t),s=2**i(.9*(o(this._minScale)+this._scale)),a=Object(g.x)(this._fontSize/s);this._gText.attr("font-size",`${a}px`);const r=this._gText.selectAll("text").data(this._portData,t=>t.id);r.exit().remove();const n=r.enter().append("text").text(t=>t.properties.name);r.merge(n).attr("x",t=>this._updateTextsX(t,e)).attr("y",t=>this._updateTextsY(t,e,a)).attr("text-anchor",t=>this._updateTextsAnchor(t)),this._gText.classed("d-none",!1)}}_updateSummary(){const t=Object.keys(this._portData).length;let e=0,s=0;t&&(e=this._portData.map(t=>t.properties.taxIncome).reduce((t,e)=>t+e),s=this._portData.map(t=>t.properties.netIncome).reduce((t,e)=>t+e)),this._portSummaryTextNumPorts.text(`${t}`),this._portSummaryTextTaxIncome.text(`${Object(g.o)(e)}`),this._portSummaryTextNetIncome.text(`${Object(g.o)(s)}`)}_updateCounties(){if("portLabel"!==this._zoomLevel)this._gCounty.classed("d-none",!0);else{const t=this._countyPolygon,e=this._gCounty.selectAll("text").data(t);e.exit().remove(),e.enter().append("text").attr("transform",t=>`translate(${t.centroid[0]},${t.centroid[1]})rotate(${t.angle})`).text(t=>t.name),this._gCounty.classed("d-none",!1)}}_updateRegions(){if("initial"!==this._zoomLevel)this._gRegion.classed("d-none",!0);else{const t=this._regionPolygon,e=this._gRegion.selectAll("text").data(t);e.exit().remove(),e.enter().append("text").attr("transform",t=>`translate(${t.centroid[0]},${t.centroid[1]})rotate(${t.angle})`).text(t=>t.name),this._gRegion.classed("d-none",!1)}}update(t){void 0===t&&(t=null),this._scale=t||this._scale,this._updateIcons(),this._updatePortCircles(),this.updateTexts(),this._updateSummary(),this._updateCounties(),this._updateRegions()}set portDataDefault(t){this._portDataDefault=t}get portDataDefault(){return this._portDataDefault}set portData(t){this._portData=t}get portData(){return this._portData}set pbData(t){this._pbData=t}get pbData(){return this._pbData}set showRadiusSetting(e){this._showRadius=e,t(`#show-radius-${e}`).prop("checked",!0),this._storeShowRadiusSetting()}set currentPort(t){this._currentPort=t}get currentPort(){return this._currentPort}set zoomLevel(t){this._zoomLevel=t}get zoomLevel(){return this._zoomLevel}_showSummary(){this._divPortSummary.classed("hidden",!1)}hideSummary(){this._divPortSummary.classed("hidden",!0)}transform(t){this._gPort.attr("transform",t)}clearMap(t){"position"===this._showRadius&&(this._showRadius="off"),this._trilateratePosition.clearMap(),this._showSummary(),this._portData=this._portDataDefault,this.showCurrentGood=!1,this.showTradePortPartners=!1,this.update(t)}}}).call(this,s("xeH2"))},cAXh:function(t,e,s){"use strict";(function(t){s.d(e,"a",function(){return _});var i=s("4aJ6"),a=(s.n(i),s("asZ9")),o=(s.n(a),s("W1QL")),r=(s.n(o),s("btHz")),n=(s.n(r),s("TiKg")),d=s.n(n),h=s("+NlM"),l=(s.n(h),s("kCRU")),p=(s.n(l),s("f4w0")),c=s("Av7d");class _{constructor(e,s){this._ports=e,this._pbZone=s,this._dateFormat="D MMM",this._timeFormat="HH.00",this._portNamesId="port-names-select",this._portNamesSelector=document.getElementById(this._portNamesId),this._portNames$=t(`#${this._portNamesId}`),this._buyGoodsId="buy-goods-select",this._buyGoodsSelector=document.getElementById(this._buyGoodsId),this._buyGoods$=t(`#${this._buyGoodsId}`),this._propNationId="prop-nation-select",this._propNationSelector=document.getElementById(this._propNationId),this._propNation$=t(`#${this._propNationId}`),this._propClanId="prop-clan-select",this._propClanSelector=document.getElementById(this._propClanId),this._propClan$=t(`#${this._propClanId}`),this._propCMId="prop-cm-select",this._propCMSelector=document.getElementById(this._propCMId),this._propCM$=t(`#${this._propCMId}`),this._setupSelects(),this._setupListener()}_setupSelects(){this._setupPortSelect(),this._setupGoodSelect(),this._setupNationSelect(),this._setupClanSelect(),this._setupCMSelect()}_resetOtherSelects(t){[this._portNames$,this._buyGoods$,this._propNation$,this._propClan$,this._propCM$].forEach(e=>{e===t||e===this._propClan$&&t===this._propNation$||e===this._propNation$&&t===this._propClan$||e.val("default").selectpicker("refresh")})}_setupListener(){t.fn.selectpicker.Constructor.DEFAULTS.virtualScroll=!0,t.fn.selectpicker.Constructor.DEFAULTS.width="fit",t.fn.selectpicker.Constructor.DEFAULTS.dropupAuto=!1,t.fn.selectpicker.Constructor.DEFAULTS.liveSearch=!0,t.fn.selectpicker.Constructor.DEFAULTS.liveSearchPlaceholder="Search ...",t.fn.selectpicker.Constructor.DEFAULTS.liveSearchNormalize=!0,this._portNamesSelector.addEventListener("change",t=>{Object(p.b)("Menu","Move to port"),this._resetOtherSelects(this._portNames$),this._portSelected(t),t.preventDefault()}),this._buyGoodsSelector.addEventListener("change",t=>{Object(p.b)("Menu","Select good"),this._resetOtherSelects(this._buyGoods$),this._goodSelected(t),t.preventDefault()}),this._propNationSelector.addEventListener("change",t=>{this._resetOtherSelects(this._propNation$),this._nationSelected(t),t.preventDefault()}),this._propClanSelector.addEventListener("change",t=>{this._resetOtherSelects(this._propClan$),this._clanSelected(t),t.preventDefault()}),this._propCMSelector.addEventListener("change",t=>{this._resetOtherSelects(this._propCM$),this._CMSelected(t),t.preventDefault()}),document.getElementById("menu-prop-deep").addEventListener("click",()=>this._depthSelected("deep")),document.getElementById("menu-prop-shallow").addEventListener("click",()=>this._depthSelected("shallow")),document.getElementById("menu-prop-all").addEventListener("click",()=>this._allSelected()),document.getElementById("menu-prop-green").addEventListener("click",()=>this._greenZoneSelected()),document.getElementById("menu-prop-large").addEventListener("click",()=>this._portSizeSelected("Large")),document.getElementById("menu-prop-medium").addEventListener("click",()=>this._portSizeSelected("Medium")),document.getElementById("menu-prop-small").addEventListener("click",()=>this._portSizeSelected("Small")),t.fn.datetimepicker.Constructor.Default=t.extend({},t.fn.datetimepicker.Constructor.Default,{icons:{time:"far fa-clock",date:"far fa-calendar",up:"fas fa-arrow-up",down:"fas fa-arrow-down",previous:"fas fa-chevron-left",next:"fas fa-chevron-right",today:"far fa-calendar-check",clear:"fas fa-trash",close:"fas fa-times"},timeZone:"UTC"}),t("#prop-pb-from").datetimepicker({format:this._timeFormat}),t("#prop-pb-to").datetimepicker({format:this._timeFormat}),t("#prop-pb-range").submit(e=>{this._capturePBRange(),t("#propertyDropdown").dropdown("toggle"),e.preventDefault()}),document.getElementById("menu-prop-today").addEventListener("click",()=>this._capturedToday()),document.getElementById("menu-prop-yesterday").addEventListener("click",()=>this._capturedYesterday()),document.getElementById("menu-prop-this-week").addEventListener("click",()=>this._capturedThisWeek()),document.getElementById("menu-prop-last-week").addEventListener("click",()=>this._capturedLastWeek());const e=t("#prop-from"),s=t("#prop-to");e.datetimepicker({format:this._dateFormat}),s.datetimepicker({format:this._dateFormat,useCurrent:!1}),e.on("change.datetimepicker",t=>s.datetimepicker("minDate",t.date)),s.on("change.datetimepicker",t=>e.datetimepicker("maxDate",t.date)),t("#prop-range").submit(e=>{this._captureRange(),t("#propertyDropdown").dropdown("toggle"),e.preventDefault()}),this._portNamesSelector.classList.add("selectpicker"),this._buyGoodsSelector.classList.add("selectpicker"),this._propNationSelector.classList.add("selectpicker"),this._propClanSelector.classList.add("selectpicker"),this._propCMSelector.classList.add("selectpicker"),t(".selectpicker").selectpicker(),Object(c.m)("selectPortNavbar")}_setupPortSelect(){const t=`${this._ports.portDataDefault.map(t=>({id:t.id,coord:[t.geometry.coordinates[0],t.geometry.coordinates[1]],name:t.properties.name,nation:this._ports.pbData.ports.filter(e=>e.id===t.id).map(t=>t.nation)})).sort((t,e)=>t.name<e.name?-1:t.name>e.name?1:0).map(t=>`<option data-subtext="${t.nation}" value="${t.coord}" data-id="${t.id}">${t.name}</option>`).join("")}`;this._portNamesSelector.insertAdjacentHTML("beforeend",t)}_setupGoodSelect(){const t=new Set;this._ports.portDataDefault.forEach(e=>{["consumesTrading","dropsTrading","dropsNonTrading","producesNonTrading"].forEach(s=>{e.properties[s]&&e.properties[s].forEach(e=>t.add(e.name))})});const e=`${Array.from(t).sort().map(t=>`<option>${t}</option>`).join("")}`;this._buyGoodsSelector.insertAdjacentHTML("beforeend",e)}_setupNationSelect(){const t=`${c.o.sort((t,e)=>t.sortName<e.sortName?-1:t.sortName>e.sortName?1:0).map(t=>`<option value="${t.short}">${t.name}</option>`).join("")}`;this._propNationSelector.insertAdjacentHTML("beforeend",t)}_setupClanSelect(){this._propClanSelector.innerHTML="";const t=new Set,e=new Set;this._ports.portData.forEach(t=>e.add(t.id)),this._ports.pbData.ports.filter(t=>t.capturer&&e.has(t.id)).forEach(e=>t.add(e.capturer));let s="";0===t.size?this._propClanSelector.disabled=!0:(this._propClanSelector.disabled=!1,s=`${Array.from(t).sort().map(t=>`<option value="${t}">${t}</option>`).join("")}`),this._propClanSelector.insertAdjacentHTML("beforeend",s)}_setupCMSelect(){const e=new Set;this._ports.portData.forEach(t=>e.add(t.properties.conquestMarksPension)),e.forEach(e=>{this._propCM$.append("beforeend",t("<option>",{value:e,text:e}))})}_setTradePortPartners(){const t=[],e=[];this._ports.portDataDefault.filter(t=>t.id===this._ports.tradePortId).forEach(s=>{s.properties.consumesTrading&&s.properties.consumesTrading.forEach(e=>t.push(e.name)),s.properties.dropsTrading&&s.properties.dropsTrading.forEach(t=>e.push(t.name))}),this._ports.portData=this._ports.portDataDefault.map(s=>(s.properties.goodsToSellInTradePort=[],s.properties.sellInTradePort=!1,s.properties.goodsToBuyInTradePort=[],s.properties.buyInTradePort=!1,s.properties.consumesTrading&&s.properties.consumesTrading.forEach(t=>{e.includes(t.name)&&(s.properties.goodsToBuyInTradePort.push(t.name),s.properties.buyInTradePort=!0)}),s.properties.dropsTrading&&s.properties.dropsTrading.forEach(e=>{t.includes(e.name)&&(s.properties.goodsToSellInTradePort.push(e.name),s.properties.sellInTradePort=!0)}),s)).filter(t=>t.id===this._ports.tradePortId||t.properties.sellInTradePort||t.properties.buyInTradePort)}_portSelected(e){const s=t(e.currentTarget).find(":selected"),i=s.val().split(","),a=s.data("id").toString();this._ports.currentPort={id:a,coord:{x:+i[0],y:+i[1]}},this._ports.tradePortId=a,this._setTradePortPartners(),this._pbZone._showPBZones&&this._pbZone.refresh(),this._ports.showTradePortPartners=!0,this._ports.showCurrentGood=!1,this._ports.update(),this._ports._map.initialZoomAndPan()}_goodSelected(e){const s=t(e.currentTarget).find(":selected")[0].text,i=this._ports.portDataDefault.filter(t=>t.properties.dropsTrading&&t.properties.dropsTrading.some(t=>t.name===s)||t.properties.dropsNonTrading&&t.properties.dropsNonTrading.some(t=>t.name===s)||t.properties.producesNonTrading&&t.properties.producesNonTrading.some(t=>t.name===s)).map(t=>(t.properties.isSource=!0,t)),a=this._ports.portDataDefault.filter(t=>t.properties.consumesTrading&&t.properties.consumesTrading.some(t=>t.name===s)).map(t=>(t.properties.isSource=!1,t));this._ports.showRadiusSetting="off",this._ports.portData=i.concat(a),this._ports.showCurrentGood=!0,this._ports.showTradePortPartners=!1,this._ports.update()}_nationSelected(e){const s=new Set;this._nation=t(e.currentTarget).val(),t("#propertyDropdown").dropdown("toggle"),this._ports.pbData.ports.filter(t=>t.nation===this._nation).forEach(t=>s.add(t.id)),this._ports.portData=this._ports.portDataDefault.filter(t=>s.has(t.id)),this._ports.showCurrentGood=!1,this._ports.showTradePortPartners=!1,this._ports.update(),this._setupClanSelect(),this._propClan$.selectpicker("refresh")}_clanSelected(e){const s=new Set,i=t(e.currentTarget).val();t("#propertyDropdown").dropdown("toggle"),0===i?this._nation&&this._ports.pbData.ports.filter(t=>t.nation===this._nation).forEach(t=>s.add(t.id)):this._ports.pbData.ports.filter(t=>i===t.capturer).forEach(t=>s.add(t.id)),this._ports.portData=this._ports.portDataDefault.filter(t=>s.has(t.id)),this._ports.showCurrentGood=!1,this._ports.showTradePortPartners=!1,this._ports.update()}_depthSelected(t){const e=this._ports.portDataDefault.filter(e=>"shallow"===t?e.properties.shallow:!e.properties.shallow);this._ports.portData=e,this._ports.showCurrentGood=!1,this._ports.showTradePortPartners=!1,this._ports.update()}_allSelected(){const t=this._ports.portDataDefault.filter(t=>t.properties.availableForAll);this._ports.portData=t,this._ports.showCurrentGood=!1,this._ports.showTradePortPartners=!1,this._ports.update()}_greenZoneSelected(){const t=this._ports.portDataDefault.filter(t=>t.properties.nonCapturable&&"FT"!==t.properties.nation);this._ports.portData=t,this._ports.showCurrentGood=!1,this._ports.showTradePortPartners=!1,this._ports.update()}_portSizeSelected(t){const e=this._ports.portDataDefault.filter(e=>t===e.properties.portBattleType);this._ports.portData=e,this._ports.showCurrentGood=!1,this._ports.showTradePortPartners=!1,this._ports.update()}_capturePBRange(){const e=[8,9,10],s=24-(e.length+1),i=new Set,a=d()(t("#prop-pb-from-input").val(),this._timeFormat).hour();let o=d()(t("#prop-pb-to-input").val(),this._timeFormat).hour();if(!(e.includes(a)&&e.includes(o)&&a<=o)){i.add(0),o<a&&(o+=24);for(let t=a-2;t<=o-3;t+=1)i.add((t-10)%s)}const r=this._ports.portDataDefault.filter(t=>!t.properties.nonCapturable&&"FT"!==t.properties.nation&&i.has(t.properties.portBattleStartTime));this._ports.portData=r,this._ports.showCurrentGood=!1,this._ports.showTradePortPartners=!1,this._ports.update()}_filterCaptured(t,e){const s=new Set;this._ports.pbData.ports.filter(s=>d()(s.lastPortBattle).isBetween(t,e,null,"(]")).forEach(t=>s.add(t.id));const i=this._ports.portDataDefault.filter(t=>s.has(t.id));this._ports.portData=i,this._ports.showCurrentGood=!1,this._ports.showTradePortPartners=!1,this._ports.update()}_capturedToday(){const t=d.a.utc();let e=d()().utc().hour(11).minute(0);t.hour()<e.hour()&&(e=e.subtract(1,"day")),this._filterCaptured(e,d.a.utc(e).add(1,"day"))}_capturedYesterday(){const t=d.a.utc();let e=d()().utc().hour(11).minute(0).subtract(1,"day");t.hour()<e.hour()&&(e=e.subtract(1,"day")),this._filterCaptured(e,d.a.utc(e).add(1,"day"))}_capturedThisWeek(){const t=d()().utc().startOf("week"),e=t.hour(11),s=d()(t).add(7,"day").hour(11);this._filterCaptured(e,s)}_capturedLastWeek(){const t=d()().utc().startOf("week"),e=d()(t).subtract(7,"day").hour(11),s=t.hour(11);this._filterCaptured(e,s)}_captureRange(){const e=d()(t("#prop-from-input").val(),this._dateFormat).hour(11),s=d()(t("#prop-to-input").val(),this._dateFormat).add(1,"day").hour(11);this._filterCaptured(e,s)}_CMSelected(){const e=parseInt(this._propCM$.val(),10);let s;s=0===e?this._ports.portDataDefault:this._ports.portDataDefault.filter(t=>e===t.properties.conquestMarksPension),t("#propertyDropdown").dropdown("toggle"),this._ports.portData=s,this._ports.showTradePortPartners=!1,this._ports.update()}clearMap(){this._setupClanSelect(),this._propClan$.selectpicker("refresh")}}}).call(this,s("xeH2"))},cCJq:function(t,e,s){"use strict";var i=Math.round;s.d(e,"a",function(){return h});var a=s("ntgT"),o=s("nUlG"),r=s("wbYc"),n=s("0lY5"),d=s("Av7d");class h{constructor(t){this._map=t,this._isShown=!0,this._minCoord=this._map.coord.min,this._maxCoord=this._map.coord.max,this._height=this._map.height,this._width=this._map.width,this._defaultFontSize=this._map.rem,this._textPadding=this._defaultFontSize/2,this._xBackgroundHeight=this._map.xGridBackgroundHeight,this._yBackgroundWidth=this._map.yGridBackgroundWidth,this._setupSvg()}_setupSvg(){this._setupScale(),this._setupAxis()}_setupScale(){this._xScale=Object(r.scaleLinear)().clamp(!0).domain([Object(d.g)(this._minCoord,this._minCoord),Object(d.g)(this._maxCoord,this._maxCoord)]).range([this._minCoord,this._maxCoord]),this._yScale=Object(r.scaleLinear)().clamp(!0).domain([Object(d.h)(this._minCoord,this._minCoord),Object(d.h)(this._maxCoord,this._maxCoord)]).range([this._minCoord,this._maxCoord])}_setupAxis(){const t=this._getTicks(65);this._xAxis=Object(a.a)(this._xScale).tickFormat(n.j).tickValues(t).tickSize(this._maxCoord),this._yAxis=Object(a.c)(this._yScale).tickFormat(n.j).tickValues(t).tickSize(this._maxCoord),this._gAxis=this._map.svg.insert("g","g.pb").classed("axis d-none",!0),this._gXAxis=this._gAxis.append("g").classed("axis-x",!0),this._gYAxis=this._gAxis.append("g").classed("axis-y",!0),this._setupBackground(),this._displayAxis(),this._setupXAxis(),this._setupYAxis()}_getTicks(t){const e=i(Object(d.h)(this._minCoord,this._minCoord)),s=i(Object(d.h)(this._maxCoord,this._maxCoord)),a=(s-e)/(t-1),o=[];for(let t=a;t<s;t+=a)o.push(i(t));o.push(s);const r=o.slice(0).reverse().map(t=>-t);return r.push(0),r.concat(o)}_setupXAxis(){this._gXAxis.selectAll(".tick text").attr("dx","-0.3em").attr("dy","2em"),this._gXAxis.attr("text-anchor","end").attr("fill",null).attr("font-family",null)}_setupYAxis(){this._gYAxis.attr("text-anchor","end").attr("fill",null).attr("font-family",null),this._gYAxis.selectAll(".tick text").attr("dx","3.5em").attr("dy","-.3em")}_displayAxis(){this._displayXAxis(),this._displayYAxis()}_displayXAxis(){const t=o.event?o.event.transform.k:1,e=o.event?o.event.transform.y:0,s=e/t<this._width?e/t:0,i=-this._maxCoord-s,a=Object(n.x)(this._defaultFontSize/t),r=Object(n.x)(1/t);this._gXAxis.attr("font-size",a).attr("stroke-width",r).call(this._xAxis.tickPadding(i)),this._gXAxis.select(".domain").remove()}_displayYAxis(){const t=o.event?o.event.transform.k:1,e=o.event?o.event.transform.x:0,s=e/t<this._height?e/t:0,i=-this._maxCoord-s,a=Object(n.x)(this._defaultFontSize/t),r=Object(n.x)(1/t);this._gYAxis.attr("font-size",a).attr("stroke-width",r).call(this._yAxis.tickPadding(i)),this._gYAxis.select(".domain").remove()}_setupBackground(){this._gBackground=this._map.svg.insert("g","g.axis").classed("grid-background d-none",!0),this._gBackground.append("rect").attr("height",this._xBackgroundHeight).attr("width",this._width),this._gBackground.append("rect").attr("height",this._height).attr("width",this._yBackgroundWidth)}set show(t){this._isShown=t}set zoomLevel(t){this._zoomLevel=t}update(){let t=!1,e=0;this._isShown&&"initial"!==this._zoomLevel&&(t=!0,e=this._xBackgroundHeight),this._gAxis.classed("d-none",!t),this._gBackground.classed("d-none",!t),Object(o.select)("#port-summary").style("margin-top",`${e}px`),Object(o.select)("#journey-summary").style("margin-top",`${e}px`)}transform(t){this._gAxis.attr("transform",t),this._displayAxis()}}},eqiN:function(t,e,s){"use strict";(function(t){s.d(e,"a",function(){return n});var i=s("/lKO"),a=s("nUlG"),o=s("2W1i"),r=s.n(o);class n{constructor(t,e,s,i,a){this._ports=a,this._pbCircleDataDefault=t,this._pbCircleData=t,this._fortDataDefault=e,this._fortData=e,this._towerDataDefault=s,this._towerData=s,this._joinCircleDataDefault=i,this._joinCircleData=i,this._showPBCookieName="na-map--show-pb",this._showPBDefault="all",this._showPB=this._getShowPBSetting(),this._setupSvg(),this._setupListener()}_setupSvg(){this._g=Object(a.select)("#na-svg").insert("g","g.ports").classed("pb",!0),this._gJoinCirclesInner=this._g.append("path").classed("join-circle",!0),this._gJoinCirclesOuter=this._g.append("path").classed("join-circle",!0),this._gPBCircles=this._g.append("path").classed("pb-circle",!0),this._gTowers=this._g.append("path").classed("tower",!0),this._gForts=this._g.append("path").classed("fort",!0)}_setupListener(){t("#show-pb").change(()=>this._showPBZonesSelected())}_getShowPBSetting(){let e=r.a.get(this._showPBCookieName);return e=void 0===e?this._showPBDefault:e,t(`#show-pb-${e}`).prop("checked",!0),e}_storeShowPBSetting(){this._showPB===this._showPBDefault?r.a.remove(this._showPBCookieName):r.a.set(this._showPBCookieName,this._showPB)}_refreshPBZones(){this.refresh(),this._ports.updateTexts()}_showPBZonesSelected(){this._showPB=t("input[name='showPB']:checked").val(),this._storeShowPBSetting(),this._refreshPBZones()}_update(){this._gPBCircles.datum(this._pbCircleData).attr("d",Object(i.a)().pointRadius(3.5)),this._gTowers.datum(this._towerData).attr("d",Object(i.a)().pointRadius(1.5)),this._gForts.datum(this._fortData).attr("d",Object(i.a)().pointRadius(2)),this._gJoinCirclesInner.datum(this._joinCircleData).attr("d",Object(i.a)().pointRadius(14)),this._gJoinCirclesOuter.datum(this._joinCircleData).attr("d",Object(i.a)().pointRadius(28))}_isPortIn(t){return"all"===this._showPB||"single"===this._showPB&&t.id===this._ports.currentPort.id}_setData(){"pbZone"===this._ports.zoomLevel&&"noShow"!==this._showPB?(this._pbCircleData={type:"FeatureCollection",features:this._pbCircleDataDefault.filter(t=>this._isPortIn(t))},this._fortData={type:"FeatureCollection",features:this._fortDataDefault.filter(t=>this._isPortIn(t))},this._towerData={type:"FeatureCollection",features:this._towerDataDefault.filter(t=>this._isPortIn(t))},this._joinCircleData={type:"FeatureCollection",features:this._joinCircleDataDefault.filter(t=>this._isPortIn(t))}):(this._pbCircleData={},this._fortData={},this._towerData={},this._joinCircleData={})}refresh(){this._setData(),this._update()}transform(t){this._g.attr("transform",t)}}}).call(this,s("xeH2"))},q1r0:function(t,e,s){"use strict";(function(t){var i=Number.isFinite;s.d(e,"a",function(){return h});var a=s("GjCE"),o=(s.n(a),s("nUlG")),r=s("0lY5"),n=s("Av7d"),d=s("f4w0");class h{constructor(t,e){this._map=t,this._coord=e,this._baseName="Go to F11",this._baseId="go-to-f11",this._buttonId=`button-${this._baseId}`,this._modalId=`modal-${this._baseId}`,this._formId=`form-${this._baseId}`,this._xInputId=`input-x-${this._baseId}`,this._zInputId=`input-z-${this._baseId}`,this._copyButtonId=`copy-coord-${this._baseId}`,this._submitButtonId=`submit-${this._baseId}`,this._modal$=null,this._setupSvg(),this._setupListener()}_setupSvg(){this._g=Object(o.select)("#na-svg").append("g").classed("f11",!0)}_navbarClick(t){Object(d.b)("Menu","Go to F11"),t.stopPropagation(),this._f11Selected()}_setupListener(){document.getElementById(`${this._buttonId}`).addEventListener("click",t=>this._navbarClick(t)),window.onkeydown=(t=>{"F11"===t.code&&t.shiftKey&&this._navbarClick(t)})}_injectModal(){Object(n.n)(this._modalId,this._baseName,"sm");const t=Object(o.select)(`#${this._modalId} .modal-body`).append("form").attr("id",this._formId).attr("role","form");this._formSel=t.node(),t.append("div").classed("alert alert-primary",!0).text("Use F11 in open world.");const e=t.append("div").classed("form-group",!0).append("div").classed("input-group",!0);e.append("label").attr("for",this._xInputId),e.append("input").classed("form-control",!0).attr("id",this._xInputId).attr("type","number").attr("required","").attr("placeholder","X coordinate").attr("min","-819").attr("max","819").attr("step","1").attr("tabindex","1"),e.append("div").classed("input-group-append",!0).append("span").classed("input-group-text",!0).text("k");const s=t.append("div").classed("form-group",!0).append("div").classed("input-group",!0);s.append("label").attr("for",this._zInputId),s.append("input").classed("form-control",!0).attr("id",this._zInputId).attr("type","number").attr("required","").attr("placeholder","Z coordinate").attr("step","1").attr("min","-819").attr("max","819").attr("tabindex","2"),s.append("div").classed("input-group-append",!0).append("span").classed("input-group-text",!0).text("k"),t.append("div").classed("alert alert-primary",!0).append("small").html("In k units (divide by 1,000).<br>Example: <em>43</em> for value of <em>43,162.5</em>.");const i=t.append("div").classed("float-right btn-group",!0).attr("role","group");i.append("button").classed("btn btn-outline-secondary",!0).attr("id",this._copyButtonId).attr("title","Copy to clipboard (ctrl-c)").attr("type","button").append("i").classed("far fa-copy",!0),i.append("button").classed("btn btn-outline-secondary",!0).attr("id",this._submitButtonId).attr("title","Go to").attr("type","submit").text("Go to"),Object(o.select)(`#${this._modalId} .modal-footer`).remove()}_initModal(){this._injectModal()}_f11Selected(){this._modal$||(this._initModal(),this._modal$=t(`#${this._modalId}`),this._xInputSel=document.getElementById(this._xInputId),this._zInputSel=document.getElementById(this._zInputId),this._formSel.onsubmit=(t=>{this._modal$.modal("hide"),t.preventDefault(),this._useUserInput()}),this._modal$.on("keydown",t=>{"KeyC"===t.code&&t.ctrlKey&&this._copyCoordClicked(t)}),document.getElementById(this._copyButtonId).addEventListener("click",t=>{this._copyCoordClicked(t)})),this._modal$.modal("show"),this._xInputSel.focus(),this._xInputSel.select()}_getInputValue(t){const e=t.value;return""===e?1/0:+e}_getXCoord(){return this._getInputValue(this._xInputSel)}_getZCoord(){return this._getInputValue(this._zInputSel)}_useUserInput(){const t=-1e3*this._getXCoord(),e=-1e3*this._getZCoord();i(t)&&i(e)&&this._goToF11(t,e)}_copyCoordClicked(t){const e=t=>{if(!document.queryCommandSupported||!document.queryCommandSupported("copy"))return console.error(`Insufficient rights to copy ${t} to clipboard`),!1;{const e=document.createElement("input");e.type="text",e.value=t,e.style="position: absolute; left: -1000px; top: -1000px",this._modal$.append(e),e.select();try{return document.execCommand("copy")}catch(t){return console.error("Copy to clipboard failed.",t),!1}finally{e.remove()}}};Object(d.b)("Menu","Copy F11 coordinates"),t.preventDefault();const s=this._getXCoord(),a=this._getZCoord();if(i(s)&&i(a)){const t=new URL(window.location);t.searchParams.set("x",s),t.searchParams.set("z",a),(t=>navigator.permissions.query({name:"clipboard-write"}).then(e=>{if("granted"===e.state||"prompt"===e.state)return navigator.clipboard.writeText(t).then(()=>!0,()=>(console.error(`Cannot copy ${t} to clipboard`),!1))},()=>e(t)))(t.href)}}_printF11Coord(t,e,s,i){const a=this._g.append("g").attr("transform",`translate(${t},${e})`);a.append("circle").attr("r",10),a.append("text").attr("dx","-.6em").attr("dy","-.5em").text(Object(r.j)(s)),a.append("text").attr("dx","-.6em").attr("dy",".5em").text(Object(r.j)(i))}_goToF11(t,e){const s=+t,i=+e,a=Object(n.e)(s,i),o=Object(n.f)(s,i);Object(r.a)(a,this._coord.min,this._coord.max,!0)&&Object(r.a)(o,this._coord.min,this._coord.max,!0)&&(this._printF11Coord(a,o,s,i),this._map.zoomAndPan(a,o,1))}checkF11Coord(){const t=new URL(document.location).searchParams;if(t.has("x")&&t.has("z")){const e=-1e3*+t.get("x"),s=-1e3*+t.get("z");Object(d.b)("Menu","Paste F11 coordinates"),this._goToF11(e,s)}else history.pushState("","",window.location.pathname)}printCoord(t,e){const s=Object(n.g)(t,e),i=Object(n.h)(t,e);this._printF11Coord(t,e,s,i)}transform(t){this._g.attr("transform",t)}clearMap(){this._g.selectAll("*").remove()}}}).call(this,s("xeH2"))},vi22:function(t,e,s){"use strict";var i=Math.log2,a=Math.max,o=Math.round,r=Math.floor;s.r(e),function(t){var n=Math.min;s.d(e,"Map",function(){return D});var d=s("4aJ6"),h=(s.n(d),s("W1QL")),l=(s.n(h),s("/Cyf")),p=s("nUlG"),c=s("NRFW"),_=s("fED9"),u=s("2W1i"),m=s.n(u),g=s("Av7d"),b=s("0lY5"),f=s("f4w0"),y=s("eqiN"),S=s("FmV8"),w=s("cAXh"),v=s("q1r0"),x=s("cCJq"),C=s("8gAj"),I=s("62GW");class D{constructor(t){this._serverName=t,this._dataDir="data",this._dataSources=[{fileName:`${t}.json`,name:"ports"},{fileName:`${t}-pb.json`,name:"pb"},{fileName:"pb.json",name:"pbZones"},{fileName:"ships.json",name:"ships"},{fileName:"woods.json",name:"woods"}],this.rem=g.j,this._navbarBrandPaddingLeft=r(1.618*this.rem),this.xGridBackgroundHeight=r(3*this.rem),this.yGridBackgroundWidth=r(4*this.rem),this.coord={min:0,max:8192},this._currentTranslate={},this._navbarSelector=document.querySelector(".navbar"),this._tileSize=256,this._maxScale=8,this._wheelDelta=.5,this._PBZoneZoomThreshold=1.5,this._labelZoomThreshold=.5,this._doubleClickActionCookieName="na-map--double-click",this._doubleClickActionDefault="compass",this._doubleClickAction=this._getDoubleClickAction(),this._showLayerCookieName="na-map--show-layer",this._showLayerDefault="grid",this._showLayer=this._getShowLayer(),this._setHeightWidth(),this._setupScale(),this._setupSvg(),this._setSvgSize(),this._setupListener(),this._setupProps(),this._readData()}_getDoubleClickAction(){let t=m.a.get(this._doubleClickActionCookieName);return t=void 0===t?this._doubleClickActionDefault:t}_getShowLayer(){let t=m.a.get(this._showLayerCookieName);return t=void 0===t?this._showLayerDefault:t}_setupData(t){function e(t){return t.filter(t=>i.includes(t.id)).map(t=>({type:"Feature",id:t.id,geometry:t.geometry}))}const s=Object(_.a)(t.ports,t.ports.objects.ports),i=s.features.filter(t=>!t.properties.nonCapturable).map(t=>t.id);this._f11=new v.a(this,this.coord),this._ports=new S.a(s.features,t.pb,this);let a=Object(_.a)(t.pbZones,t.pbZones.objects.pbCircles);a=e(a.features);let o=Object(_.a)(t.pbZones,t.pbZones.objects.forts);o=e(o.features);let r=Object(_.a)(t.pbZones,t.pbZones.objects.towers);r=e(r.features);let n=Object(_.a)(t.pbZones,t.pbZones.objects.joinCircles);n=e(n.features),this._pbZone=new y.a(a,o,r,n,this._ports),this._woodData=JSON.parse(JSON.stringify(t.woods)),this._shipData=JSON.parse(JSON.stringify(t.ships.shipData)),this._journey=new C.a(this._shipData,this._woodData,this.rem),this._portSelect=new w.a(this._ports,this._pbZone),this._windPrediction=new I.a,this._grid=new x.a(this),this._init()}_readData(){const t=[],e={};this._dataSources.forEach((e,s)=>{t[s]=fetch(`${this._dataDir}/${e.fileName}`).then(b.c).then(b.q)}),Promise.all(t).then(t=>{t.forEach((s,i)=>{e[this._dataSources[i].name]=t[i]}),this._setupData(e)}).catch(b.v)}_setupListener(){this.svg.on("dblclick.zoom",null).on("click",function(){p.event.defaultPrevented&&p.event.stopPropagation()},!0).on("dblclick",(t,e,s)=>this._doDoubleClickAction(s[e])),t("#reset").on("click",()=>{this._clearMap()}),t("#propertyDropdown").on("click",()=>{Object(f.b)("Menu","Select port on property")}),t("#settingsDropdown").on("click",()=>{Object(f.b)("Menu","Settings")}),t("#button-download-pb-calc").on("click",()=>{Object(f.b)("Tools","Download pb calculator")}),t("#doubleClick-action").change(()=>this._doubleClickSelected()),t("#show-layer").change(()=>this._showLayerSelected()),t("#about").on("click",()=>{this._showAbout()})}_setupScale(){this._minScale=Object(b.t)(n(this.width/this.coord.max,this.height/this.coord.max)),this._currentScale=this._minScale}_setupSvg(){this._zoom=Object(c.a)().wheelDelta(()=>-this._wheelDelta*Math.sign(p.event.deltaY)).translateExtent([[this.coord.min-this.yGridBackgroundWidth*this._minScale,this.coord.min-this.xGridBackgroundHeight*this._minScale],[this.coord.max,this.coord.max]]).scaleExtent([this._minScale,this._maxScale]).on("zoom",()=>this._naZoomed()),this.svg=Object(p.select)("#na-map").append("svg").attr("id","na-svg").call(this._zoom),this.svg.append("defs"),this._gMap=this.svg.append("g").classed("map",!0)}_setupProps(){t(`#doubleClick-action-${this._doubleClickAction}`).prop("checked",!0),t(`#show-layer-${this._showLayer}`).prop("checked",!0)}_storeDoubleClickActionSetting(){this._doubleClickAction===this._doubleClickActionDefault?m.a.remove(this._doubleClickActionCookieName):m.a.set(this._doubleClickActionCookieName,this._doubleClickAction)}_doubleClickSelected(){this._doubleClickAction=t("input[name='doubleClickAction']:checked").val(),this._storeDoubleClickActionSetting(),this._clearMap()}_storeShowLayerSetting(){this._showLayer===this._showLayerDefault?m.a.remove(this._showLayerCookieName):m.a.set(this._showLayerCookieName,this._showLayer)}_showLayerSelected(){this._showLayer=t("input[name='showLayer']:checked").val(),this._storeShowLayerSetting(),this._refreshLayer()}_refreshLayer(){const t="grid"===this._showLayer;this._grid.show=t,this._grid.update()}_displayMap(t){var e=Math.ceil;const s=t.x,d=t.y,h=t.k,p=i(this._tileSize),_=i(this.coord.max)-p,u=this.coord.max*h,m=this.width,g=this.height,f=r(u<this.width?this.width-2*s:u),y=r(u<this.height?this.height-2*d:u),S=i(h),w=n(_,e(i(a(f,y)))-p),v=o(10*(w-S-_))/10,x=this._wheelDelta**v,C=this._tileSize*x,I=u<this.width?s:0,D=u<this.height?d:0,j=Object(l.e)(a(0,r((0-s)/C)),a(0,n(e((m-s-I)/C),2**w))),k=Object(l.e)(a(0,r((0-d)/C)),a(0,n(e((g-d-D)/C),2**w))),P=[];k.forEach(t=>{j.forEach(e=>{P.push({z:w,row:t,col:e,id:`${w.toString()}-${t.toString()}-${e.toString()}`})})}),P.transform=c.b.translate(s,d).scale(Object(b.x)(x)),this._updateMap(P)}_updateMap(t){const e=this._gMap.attr("transform",t.transform).selectAll("image").data(t,t=>t.id);e.exit().remove(),e.enter().append("image").attr("xlink:href",t=>`images/map/${t.z}/${t.row}/${t.col}.jpg`).attr("x",t=>t.col*this._tileSize).attr("y",t=>t.row*this._tileSize).attr("width",this._tileSize).attr("height",this._tileSize)}_clearMap(){this._windPrediction.clearMap(),this._f11.clearMap(),this._ports.clearMap(),this._portSelect.clearMap(),t(".selectpicker").val("default").selectpicker("refresh")}_showAbout(){const e="modal-about";document.getElementById(e)||function(t){Object(g.n)(t,`${g.b} <span class="text-primary small">v${g.c}</span>`,""),Object(p.select)(`#${t} .modal-body`).html(`<p>${g.a} Please check the <a href="https://forum.game-labs.net/topic/23980-yet-another-map-naval-action-map/"> Game-Labs forum post</a> for further details. Feedback is very welcome.</p><p>Designed by iB aka Felix Victor, clan <a href="https://bccnavalaction.freeforums.net/">British Captains’ Club (BCC)</a>.</p>`)}(e),t(`#${e}`).modal("show")}_doDoubleClickAction(t){const e=Object(p.mouse)(t),s=Object(c.c)(t),i=e[0],a=e[1],o=s.k,r=(i-s.x)/o,n=(a-s.y)/o;"f11"===this._doubleClickAction?this._f11.printCoord(r,n):this._journey.plotCourse(r,n),this.zoomAndPan(r,n,1)}_updateCurrent(){this._pbZone.refresh(),this._grid.update(),this._ports.update(this._currentScale)}_setZoomLevelAndData(){p.event.transform.k!==this._currentScale&&(this._currentScale=p.event.transform.k,this._currentScale>this._PBZoneZoomThreshold?"pbZone"!==this._zoomLevel&&(this.zoomLevel="pbZone"):this._currentScale>this._labelZoomThreshold?"portLabel"!==this._zoomLevel&&(this.zoomLevel="portLabel"):"initial"!==this._zoomLevel&&(this.zoomLevel="initial"),this._updateCurrent())}_naZoomed(){this._setZoomLevelAndData(),this._currentTranslate.x=r(p.event.transform.x),this._currentTranslate.y=r(p.event.transform.y);const t=c.b.translate(this._currentTranslate.x,this._currentTranslate.y).scale(Object(b.x)(p.event.transform.k));this._displayMap(t),this._grid.transform(t),this._ports.transform(t),this._journey.transform(t),this._pbZone.transform(t),this._f11.transform(t)}_init(){this.zoomLevel="initial",this.initialZoomAndPan(),this._refreshLayer(),this._ports.clearMap(this._minScale),this._f11.checkF11Coord()}set zoomLevel(t){this._zoomLevel=t,this._ports.zoomLevel=t,this._grid.zoomLevel=t}resize(){const t=c.b.translate(this._currentTranslate.x,this._currentTranslate.y).scale(this._currentScale);this._setHeightWidth(),this._setSvgSize(),this._displayMap(t),this._grid.update()}_getDimensions(){return document.getElementById("na-map").getBoundingClientRect()}_getWidth(){const t=this._getDimensions().width;return r(t)}_getHeight(){const t=this._getDimensions().top,e=document.documentElement.clientHeight-this.rem;return r(e-t)}_setHeightWidth(){this.width=this._getWidth(),this.height=this._getHeight()}_setSvgSize(){this.svg.attr("width",this.width).attr("height",this.height).call(this._zoom)}initialZoomAndPan(){this.svg.call(this._zoom.scaleTo,this._minScale)}zoomAndPan(t,e,s){const i=c.b.scale(s).translate(o(-t+this.width/2/s),o(-e+this.height/2/s));this.svg.call(this._zoom.transform,i)}goToPort(){"0"===this._ports.currentPort.id?this.initialZoomAndPan():this.zoomAndPan(this._ports.currentPort.coord.x,this._ports.currentPort.coord.y,2)}}}.call(this,s("xeH2"))}}]);